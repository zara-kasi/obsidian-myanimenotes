name: Sync README from Vault

on:
  # Manual trigger
  workflow_dispatch:
  
  # Scheduled run Weekly on Sunday
  schedule:
    - cron: '0 0 * * 0'

jobs:
  sync-readme:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout plugin repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Fetch README from vault repository
        id: fetch
        env:
          VAULT_TOKEN: ${{ secrets.VAULT_ACCESS_TOKEN }}
          VAULT_OWNER: ${{ secrets.VAULT_REPO_OWNER }}
          VAULT_REPO: ${{ secrets.VAULT_REPO_NAME }}
          VAULT_PATH: ${{ secrets.VAULT_FILE_PATH }}
        run: |
          # Fetch file content from private vault repo
          # Using GitHub API to avoid cloning entire repo
          
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -H "Authorization: token ${VAULT_TOKEN}" \
            -H "Accept: application/vnd.github.v3.raw" \
            "https://api.github.com/repos/${VAULT_OWNER}/${VAULT_REPO}/contents/${VAULT_PATH}")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          CONTENT=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "::error::Failed to fetch file from vault repository (HTTP $HTTP_CODE)"
            echo "Response: $CONTENT"
            exit 1
          fi
          
          # Save content to temporary file
          echo "$CONTENT" > /tmp/new_readme.md
          
          echo "✓ Successfully fetched README from vault"
      
      - name: Check for changes
        id: check
        run: |
          if [ ! -f "README.md" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "reason=README.md does not exist" >> $GITHUB_OUTPUT
          elif ! diff -q README.md /tmp/new_readme.md > /dev/null 2>&1; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "reason=Content has changed" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "reason=No changes detected" >> $GITHUB_OUTPUT
          fi
      
      - name: Update README
        if: steps.check.outputs.changed == 'true'
        run: |
          cp /tmp/new_readme.md README.md
          echo "✓ README.md updated"
      
      - name: Commit and push changes
        if: steps.check.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add README.md
          git commit -m "docs: sync README from vault [automated]"
          git push
          
          echo "✓ Changes committed and pushed"
      
      - name: Report result
        run: |
          if [ "${{ steps.check.outputs.changed }}" == "true" ]; then
            echo "### ✓ README Updated" >> $GITHUB_STEP_SUMMARY
            echo "Reason: ${{ steps.check.outputs.reason }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ℹ No Update Needed" >> $GITHUB_STEP_SUMMARY
            echo "Reason: ${{ steps.check.outputs.reason }}" >> $GITHUB_STEP_SUMMARY
          fi
